# Title: BPF Filter applied using TC

# Creation Date: 2025/04/10

# MITRE ATT&CK Tactics TA0002 - Execution - https://attack.mitre.org/tactics/TA0002/

# MITRE ATT&CK Techinque T1059 - Command and scripting interpreter - https://attack.mitre.org/techniques/T1059/004/

- name: BPF Filter applied using TC
  type: Exec
  category: execution
  severity: high
  description: Detects when the tc (transmission control) binary is utilized to set a BPF (Berkeley Packet Filter) on a network
    interface. Tc is used to configure Traffic Control in the Linux kernel. It can shape, schedule, police and drop traffic.
    Adversaries an utilize tc to set a bpf filter on an interface for the purpose of manipulating the incoming traffic.
    This technique is not at all common and should indicate abnormal, suspicious or malicious activity.
  condition: payload.filename STARTS_WITH "/usr/sbin/tc" AND
    payload.argv CONTAINS "filter" AND payload.argv CONTAINS "add" AND payload.argv CONTAINS "bpf"
    AND NOT header.image STARTS_WITH "/usr/sbin/libvirtd"


# Title: Suspicious mining process creation events

- name: Suspicious Mining Process Creation Event
  type: FileCreated
  category: execution
  severity: medium
  description: Detects service creation events of common mining services, possibly indicating the infection of a system with a cryptominer.
  condition: payload.filename ENDS_WITH "aliyun.service" OR
    payload.filename ENDS_WITH "moneroocean_miner.service" OR
    payload.filename ENDS_WITH "c3pool_miner.service" OR
    payload.filename ENDS_WITH "pnsd.service" OR
    payload.filename ENDS_WITH "apache4.service" OR
    payload.filename ENDS_WITH "pastebin.service" OR
    payload.filename ENDS_WITH "xvf.service"

- name: Netcat Listener Established via rlwrap
  type: Exec
  category: execution
  severity: low
  description: Monitors for the execution of a netcat listener via rlwrap. rlwrap is a 'readline wrapper', a small utility that uses
    the GNU Readline library to allow the editing of keyboard input for any command. This utility can be used in conjunction
    with netcat to gain a more stable reverse shell.
  condition: payload.filename ENDS_WITH "rlwrap"
    AND payload.argc >= 4
    AND (
      payload.argv CONTAINS "nc" OR
      payload.argv CONTAINS "ncat" OR
      payload.argv CONTAINS "netcat" OR
      payload.argv CONTAINS "nc.openbsd" OR
      payload.argv CONTAINS "socat"
    )
    AND (
      payload.argv CONTAINS "-l" OR
      payload.argv CONTAINS "--listen"
    )

- name: Interactive Terminal Spawned via Perl
  type: Exec
  category: execution
  severity: high
  description: Identifies when a terminal (tty) is spawned via Perl. Attackers may upgrade a simple reverse shell to a fully
    interactive tty after obtaining initial access to a host.
  condition: (header.image ENDS_WITH "perl" OR payload.filename ENDS_WITH "perl")
    AND (
      payload.argv CONTAINS "exec \"/bin/sh\";" OR 
      payload.argv CONTAINS "exec \"/bin/dash\";" OR
      payload.argv CONTAINS "exec \"/bin/bash\";"
    )

- name: Shell spawn with -c option
  type: Exec
  category: defense_evasion
  severity: low
  description: Detects execution of shell commands via `-c`, often used in scripted or fileless attacks.
  condition: (
      payload.filename ENDS_WITH "/bash" OR
      payload.filename ENDS_WITH "/sh" OR
      payload.filename ENDS_WITH "/dash" OR
      payload.filename ENDS_WITH "/zsh" OR
      payload.filename ENDS_WITH "/ksh" OR
      payload.filename ENDS_WITH "/fish" OR
      payload.filename ENDS_WITH "/csh" OR
      payload.filename ENDS_WITH "/tcsh"
    ) AND
    payload.argv CONTAINS "-c"
    AND NOT header.image ENDS_WITH "/code"