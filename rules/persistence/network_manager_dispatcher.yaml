# Title: NetworkManager Dispatcher Script Creation

# Creation date: 2025/04/14

# MITRE ATT&CK Tactic: TA0003 - Persistence - https://attack.mitre.org/tactics/TA0003/

# MITRE ATT&CK Technique: T1543 - reate or Modify System Process - https://attack.mitre.org/techniques/T1543/

- name: NetworkManager Dispatcher Script Creation
  type: FileCreated
  category: persistence
  severity: low
  description: Detects the creation of a NetworkManager dispatcher script on a Linux system. NetworkManager dispatcher
    scripts are shell scripts that NetworkManager executes when network interfaces change state. Attackers can abuse
    NetworkManager dispatcher scripts to maintain persistence on a system by executing malicious code whenever a network
    event occurs.
  condition: payload.filename STARTS_WITH "/etc/NetworkManager/dispatcher.d/"
    AND NOT (
      header.image IN [
        "/bin/dpkg", "/usr/bin/dpkg", "/bin/dockerd", "/usr/bin/dockerd", "/usr/sbin/dockerd", "/bin/microdnf",
        "/usr/bin/microdnf", "/bin/rpm", "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd", "/bin/yum", "/usr/bin/yum",
        "/bin/dnf", "/usr/bin/dnf", "/bin/podman", "/usr/bin/podman", "/bin/dnf-automatic", "/usr/bin/dnf-automatic",
        "/bin/pacman", "/usr/bin/pacman", "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk", "/usr/sbin/apk",
        "/usr/local/sbin/apk", "/usr/bin/apt", "/usr/sbin/pacman", "/usr/bin/puppet", "/bin/puppet",
        "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client", "/bin/chef-client", "/bin/autossl_check",
        "/usr/bin/autossl_check", "/usr/bin/pamac-daemon", "/bin/pamac-daemon", "/usr/lib/snapd/snapd",
        "/usr/local/bin/dockerd", "/usr/bin/crio", "/usr/sbin/crond", "/opt/puppetlabs/puppet/bin/ruby",
        "/usr/libexec/platform-python", "/kaniko/kaniko-executor", "/usr/bin/podman", "/bin/install",
        "/usr/lib/systemd/systemd", "/usr/sbin/sshd", "/usr/bin/gitlab-runner",
        "/opt/gitlab/embedded/bin/ruby", "/usr/sbin/gdm", "/usr/bin/install",
        "/usr/local/manageengine/uems_agent/bin/dcregister", "/usr/local/bin/pacman"
      ] OR
      header.image STARTS_WITH "/nix/store/" OR
      header.image STARTS_WITH "/var/lib/dpkg/" OR
      header.image STARTS_WITH "/tmp/vmis" OR
      header.image STARTS_WITH "/snap/" OR
      header.image STARTS_WITH "/dev/fd/" OR
      header.image STARTS_WITH "/usr/lib/virtualbox/" OR
      payload.filename ENDS_WITH ".swp" OR
      payload.filename ENDS_WITH ".swpx" OR
      payload.filename ENDS_WITH ".swx" OR
      payload.filename ENDS_WITH ".dpkg-remove" OR
      (header.image ENDS_WITH "/sed" AND payload.filename STARTS_WITH "sed")
    )
