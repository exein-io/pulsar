# Title: Python Path File (pth) Creation

# Creation date: 2025/04/14

# MITRE ATT&CK Tactic: TA0003 - Persistence - https://attack.mitre.org/tactics/TA0003/

# MITRE ATT&CK Technique: T1546 - Event Triggered Execution - https://attack.mitre.org/techniques/T1546/

- name: .pth File Creation in Python Site-Packages
  type: FileCreated
  category: persistence
  severity: low
  description: Detects the creation of .pth files in Python package directories. .pth files are used by Python to add directories to its module search path.
    Adversaries may use this technique to achieve persistence by injecting malicious code that gets executed every time the Python interpreter starts.
  condition: payload.filename ENDS_WITH "pth"
    AND (
      payload.filename STARTS_WITH "/usr/local/lib/python" OR
      payload.filename STARTS_WITH "/usr/lib/python" OR
      payload.filename STARTS_WITH "/lib/python" 
    )
    AND NOT (
      header.image IN ["pip", "restic", "pacman", "dockerd", "poetry", "pamac-daemon", "dnf", "pip3", "pip2"]
      OR header.image IN ["/usr/bin/python2", "/usr/local/bin/python2", "/opt/venv/bin/python2"]
      OR header.image IN ["/usr/bin/python3", "/usr/local/bin/python3", "/opt/venv/bin/python3"]
      OR header.image IN ["/usr/bin/python", "/usr/local/bin/python", "/opt/venv/bin/python"]
      OR header.image IN ["/nix/store/*libexec/docker/dockerd", "/snap/docker/*dockerd"]
    )
