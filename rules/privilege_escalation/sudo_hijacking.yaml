# Title: Sudo Hijacking

# Creation Date: 2025/04/14

# MITRE ATT&CK Tactics TA0004 - Privilege Escalation - https://attack.mitre.org/tactics/TA0004/

# MITRE ATT&CK Technique T1574 - Hijack Execution Flow - https://attack.mitre.ORg/techniques/T1574/


- name: Potential Sudo Hijacking
  type: FileRename
  category: privilege_escalation
  severity: medium
  description: Detects creation or renaming of the sudo binary outside of expected package managers OR installers.
  condition: (payload.destination == "/usr/bin/sudo" OR payload.destination == "/bin/sudo")
    AND NOT (
      payload.source == "/usr/bin/sudo" OR
      payload.source == "/bin/sudo" OR
      header.image IN [
        "/bin/dpkg", "/usr/bin/dpkg", "/bin/dockerd", "/usr/bin/dockerd", "/usr/sbin/dockerd", "/bin/microdnf",
        "/bin/rpm", "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd", "/bin/yum", "/usr/bin/yum", "/bin/dnf", "/usr/bin/dnf",
        "/bin/podman", "/usr/bin/podman", "/bin/dnf-automatic", "/usr/bin/dnf-automatic", "/bin/pacman", "/usr/bin/pacman",
        "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk", "/usr/sbin/apk", "/usr/local/sbin/apk", "/usr/bin/apt",
        "/usr/sbin/pacman", "/usr/bin/microdnf", "/usr/local/bin/dockerd", "/usr/local/bin/podman", "/usr/local/bin/dnf",
        "/kaniko/executOR", "/proc/self/exe", "/usr/bin/apt-get", "/usr/bin/apt-cache", "/usr/bin/apt-mark"
      ] OR
      payload.source ENDS_WITH ".dpkg-new" OR
      header.image STARTS_WITH "/nix/store/" OR
      header.image STARTS_WITH "/var/lib/dpkg/" OR
      header.image STARTS_WITH "/tmp/vmis" OR
      header.image STARTS_WITH "/snap/" OR
      header.image STARTS_WITH "/dev/fd/" OR
      header.image STARTS_WITH "/var/lib/docker/" OR
      header.image == "" OR
      (header.image ENDS_WITH "/sed" AND payload.destination STARTS_WITH "sed")
    )


- name: Potential Sudo Hijacking (Created)
  type: FileCreated
  category: privilege_escalation
  severity: medium
  description: Detects creation of the sudo binary outside of expected package managers or installers.
  condition: (payload.filename == "/usr/bin/sudo" OR payload.filename == "/bin/sudo")
    AND NOT (
      header.image IN [
        "/bin/dpkg", "/usr/bin/dpkg", "/bin/dockerd", "/usr/bin/dockerd", "/usr/sbin/dockerd", "/bin/microdnf",
        "/bin/rpm", "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd", "/bin/yum", "/usr/bin/yum", "/bin/dnf", "/usr/bin/dnf",
        "/bin/podman", "/usr/bin/podman", "/bin/dnf-automatic", "/usr/bin/dnf-automatic", "/bin/pacman", "/usr/bin/pacman",
        "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk", "/usr/sbin/apk", "/usr/local/sbin/apk", "/usr/bin/apt",
        "/usr/sbin/pacman", "/usr/bin/microdnf", "/usr/local/bin/dockerd", "/usr/local/bin/podman", "/usr/local/bin/dnf",
        "/kaniko/executor", "/proc/self/exe", "/usr/bin/apt-get", "/usr/bin/apt-cache", "/usr/bin/apt-mark"
      ] OR
      payload.filename ENDS_WITH ".dpkg-new" OR
      header.image STARTS_WITH "/nix/store/" OR
      header.image STARTS_WITH "/var/lib/dpkg/" OR
      header.image STARTS_WITH "/tmp/vmis" OR
      header.image STARTS_WITH "/snap/" OR
      header.image STARTS_WITH "/dev/fd/" OR
      header.image STARTS_WITH "/var/lib/docker/" OR
      header.image == "" OR
      (header.image ENDS_WITH "/sed" AND payload.filename STARTS_WITH "sed")
    )

