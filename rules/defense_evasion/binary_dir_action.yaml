# Title: Tampering with Executable Binary Directories

# Creation date: 2022/10/21

# MITRE ATT&CK Tactic: TA0005 - Defense Evasion - https://attack.mitre.org/tactics/TA0005/

# MITRE ATT&CK Technique: T1036.005 - Masquerading: Match Legitimate Name or Location - https://attack.mitre.org/techniques/T1036/005/

- name: Delete any file/directory below binary directories
  type: FileDeleted
  category: execution
  severity: medium
  description: Detects the deletion of files/directories below binary directories. Adversaries may delete files/directories below binary directories 
    to gain access to information or to escalate privileges.
  condition: payload.filename STARTS_WITH "/usr/bin" OR payload.filename STARTS_WITH "/usr/sbin" OR payload.filename STARTS_WITH "/bin" OR payload.filename STARTS_WITH "/sbin"
    AND NOT (
      header.image IN [
        "/usr/bin/apt", "/usr/bin/apt-get","/usr/bin/dpkg", "/usr/bin/yum", "/usr/bin/opkg",
        "/usr/bin/pacman", "/usr/bin/rpm", "/usr/bin/zypper", "/usr/bin/emerge", "/usr/bin/nix-env"]
      OR header.image STARTS_WITH "/usr/bin/dnf"
    )

- name: Create a directory below binary directories
  type: DirCreated
  category: execution
  severity: medium
  description: Detects the creation of a directory below binary directories. Adversaries may create a directory below binary directories to gain 
    access to information or to escalate privileges.
  condition: payload.dirname STARTS_WITH "/usr/bin" OR payload.dirname STARTS_WITH "/usr/sbin" OR payload.dirname STARTS_WITH "/bin" OR payload.dirname STARTS_WITH "/sbin"
    AND NOT (
      header.image IN [
        "/usr/bin/apt", "/usr/bin/apt-get","/usr/bin/dpkg", "/usr/bin/yum", "/usr/bin/opkg",
        "/usr/bin/pacman", "/usr/bin/rpm", "/usr/bin/zypper", "/usr/bin/emerge", "/usr/bin/nix-env"]
      OR header.image STARTS_WITH "/usr/bin/dnf"
      OR header.image ENDS_WITH "/dockerd"
    )

- name: Delete any directory below binary directories
  type: DirDeleted
  category: execution
  severity: medium
  description: Detects the deletion of a directory below binary directories. Adversaries may delete a directory below binary directories to gain 
    access to information or to escalate privileges.
  condition: payload.dirname STARTS_WITH "/usr/bin" OR payload.dirname STARTS_WITH "/usr/sbin" OR payload.dirname STARTS_WITH "/bin" OR payload.dirname STARTS_WITH "/sbin"
    AND NOT (
      header.image IN [
        "/usr/bin/apt", "/usr/bin/apt-get","/usr/bin/dpkg", "/usr/bin/yum", "/usr/bin/opkg",
        "/usr/bin/pacman", "/usr/bin/rpm", "/usr/bin/zypper", "/usr/bin/emerge", "/usr/bin/nix-env"]
      OR header.image STARTS_WITH "/usr/bin/dnf"
    )
    
- name: Write any file below binary directories
  type: FileOpened
  category: execution
  severity: medium
  description: Detects the write of a file below binary directories. Adversaries may write a file below binary directories to gain access to 
    information or to escalate privileges.
  condition: (payload.filename STARTS_WITH "/usr/bin" OR payload.filename STARTS_WITH "/usr/sbin" OR payload.filename STARTS_WITH "/bin" OR payload.filename STARTS_WITH "/sbin") 
    AND (payload.flags CONTAINS "O_WRONLY" OR payload.flags CONTAINS "O_RDWR")
    AND NOT (
      header.image IN [
        "/usr/bin/apt", "/usr/bin/apt-get","/usr/bin/dpkg", "/usr/bin/yum", "/usr/bin/opkg",
        "/usr/bin/pacman", "/usr/bin/rpm", "/usr/bin/zypper", "/usr/bin/emerge", "/usr/bin/nix-env"]
      OR header.image STARTS_WITH "/usr/bin/dnf"
      OR header.image ENDS_WITH "/dockerd"
    )
