# Title: Disable Apparmor Attempt

# Creation date: 2023/08/28

# MITRE ATT&CK Tactic: TA0005 - Defense Evasion - https://attack.mitre.org/tactics/TA0005/

# MITRE ATT&CK Technique: T1562 - Impair Defenses - https://attack.mitre.org/techniques/T1562/

- name: AppArmor sensitive file modification
  type: FileOpened
  category: defense_evasion
  severity: medium
  description: Detects modification of AppArmor files. Every tool under the hood use this files.
  condition: payload.filename STARTS_WITH "/sys/kernel/security/apparmor/" 
    AND (payload.flags CONTAINS "O_WRONLY" OR payload.flags CONTAINS "O_RDWR")

- name: AppArmor configuration files modification
  type: FileOpened
  category: defense_evasion
  severity: medium
  description: Detects modification of AppArmor profiles or configurations.
  condition: (
      payload.filename STARTS_WITH "/etc/apparmor/" OR
      payload.filename STARTS_WITH "/etc/apparmor.d/" OR
      payload.filename STARTS_WITH "/etc/apparmor.conf"
    )
    AND (payload.flags CONTAINS "O_WRONLY" OR payload.flags CONTAINS "O_RDWR")

- name: AppArmor daemon substitution
  type: FileRename
  category: defense_evasion
  severity: medium
  description: Detects rename or move operations that replace or relocate AppArmor profile files.
  condition: payload.source STARTS_WITH "/etc/apparmor.d/"

- name: AppArmor daemon deletion
  type: FileDeleted
  category: defense_evasion
  severity: medium
  description: Detects deletion of AppArmor profile files.
  condition: payload.filename STARTS_WITH "/etc/apparmor.d/"

- name: AppArmor symlink to disable
  type: FileLink
  category: defense_evasion
  severity: medium
  description: Detects symlinks created in /etc/apparmor.d/disable/ that persistently disable a profile (e.g., aa-disable, apparmor_parser -R commands)
  condition: payload.destination STARTS_WITH "/etc/apparmor.d/disable/"
