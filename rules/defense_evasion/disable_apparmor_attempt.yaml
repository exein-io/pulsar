# Title: Disable Apparmor Attempt

# Creation date: 2023/08/28

# MITRE ATT&CK Tactic: TA0005 - Defense Evasion - https://attack.mitre.org/tactics/TA0005/

# MITRE ATT&CK Technique: T1562 - Impair Defenses - https://attack.mitre.org/techniques/T1562/

- name: AppArmor kernel profile unload
  type: FileOpened
  category: defense_evasion
  severity: medium
  description: Detects opens of AppArmor control file .remove, which unloads a profile from the running kernel.
    Adversaries can unload specific profiles to let malware run completely outside AppArmor confinement, gaining unrestricted file and process access.
  condition: payload.filename STARTS_WITH "/sys/kernel/security/apparmor/.remove"
    AND (payload.flags CONTAINS "O_WRONLY" OR payload.flags CONTAINS "O_RDWR")

- name: AppArmor configuration files modification
  type: FileOpened
  category: defense_evasion
  severity: medium
  description: Detects modification of AppArmor profiles or configurations.
    Adversaries can edit profile rules to relax or disable restrictions, allowing targeted applications to access normally protected resources for persistence or lateral movement.
  condition: payload.filename STARTS_WITH "/etc/apparmor"
    AND (payload.flags CONTAINS "O_WRONLY" OR payload.flags CONTAINS "O_RDWR")

- name: AppArmor profile file rename
  type: FileRename
  category: defense_evasion
  severity: medium
  description: attempts to rename or move AppArmor profile files from their standard locations.
    Adversaries can relocate profiles so they are skipped on reload.
  condition: payload.source STARTS_WITH "/etc/apparmor.d/"

- name: AppArmor profile deletion
  type: FileDeleted
  category: defense_evasion
  severity: medium
  description: Detects deletion of AppArmor profile files.
  condition: payload.filename STARTS_WITH "/etc/apparmor.d/"

- name: AppArmor symlink to disable profile
  type: FileLink
  category: defense_evasion
  severity: medium
  description: Detects the creation of symlinks in /etc/apparmor.d/disable/ that persistently disable a profile (e.g., aa-disable command)
    Adversaries can persistently disable a profile across reboots, ensuring the associated program always runs without AppArmor restrictions.
  condition: payload.source STARTS_WITH "/etc/apparmor.d/disable/"

- name: AppArmor systemd disable (symlink removal)
  type: FileDeleted
  category: defense_evasion
  severity: medium
  description: Detects the removal of AppArmor's systemd unit symlinks, which disables the service from starting automatically.
    Adversaries can stop AppArmor from loading at boot, leaving the host without mandatory access controls after every reboot.
  condition: (
    payload.filename STARTS_WITH "/etc/systemd/system" OR
    payload.filename STARTS_WITH "/run/systemd/system" 
    ) AND 
    payload.filename ENDS_WITH "/apparmor.service" 

- name: Stop apparmor service with systemctl
  type: Exec
  category: defense_evasion
  severity: low
  description: Monitors for the execution of the systemctl utility with the disable, stop, or kill flag to disable or stop the apparmor service. 
  condition: payload.filename ENDS_WITH "/systemctl" AND (payload.argv CONTAINS "stop" OR payload.argv CONTAINS "kill") 
    AND (payload.argv CONTAINS "apparmor" OR payload.argv CONTAINS "apparmor.service")
